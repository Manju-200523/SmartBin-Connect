<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Bin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #2ecc71;
      color: white;
    }
    form {
      background: #fff;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 400px;
    }
    button {
      background: #27ae60;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #219150;
    }
    h2 {
      margin-top: 30px;
      color: #2c3e50;
    }
    canvas {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>üóëÔ∏è Smart Bin Monitoring Dashboard</h1>

  <h2>Bin Logs</h2>
  <table id="logsTable">
    <tr><th>Bin ID</th><th>Level (%)</th><th>Latitude</th><th>Longitude</th><th>Timestamp</th></tr>
  </table>

  <h2>Bin Level Overview</h2>
  <canvas id="binChart" width="400" height="150"></canvas>

  <h2>Submit Manual Complaint</h2>
  <form id="complaintForm">
    <label>Bin ID:</label>
    <input type="text" id="bin_id" required>
    <label>Issue:</label>
    <input type="text" id="issue" required>
    <button type="submit">Submit</button>
  </form>

  <h2>Complaints</h2>
  <table id="complaintsTable">
    <tr><th>ID</th><th>Bin ID</th><th>Issue</th><th>Status</th><th>Created At</th><th>Action</th></tr>
  </table>

  <script>
    let binChart; // global chart variable

    document.getElementById('complaintForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bin_id = document.getElementById('bin_id').value;
      const issue = document.getElementById('issue').value;

      const res = await fetch('http://localhost:5000/api/complaints/manual', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bin_id, issue })
      });

      const data = await res.json();
      alert(data.message);
      fetchData(); // refresh tables and chart
    });

    async function fetchData() {
      const logsRes = await fetch('http://localhost:5000/api/logs');
      const complaintsRes = await fetch('http://localhost:5000/api/complaints');

      const logs = await logsRes.json();
      const complaints = await complaintsRes.json();

      // Update Logs Table
      const logsTable = document.getElementById('logsTable');
      logsTable.innerHTML = '<tr><th>Bin ID</th><th>Level (%)</th><th>Latitude</th><th>Longitude</th><th>Timestamp</th></tr>';
      logs.forEach(row => {
        const color = row.bin_level > 80 ? 'red' : 'green';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.bin_id}</td><td style="color:${color}; font-weight:bold;">${row.bin_level}%</td><td>${row.latitude}</td><td>${row.longitude}</td><td>${row.timestamp}</td>`;
        logsTable.appendChild(tr);
      });

      // Update Complaints Table
      const complaintsTable = document.getElementById('complaintsTable');
      complaintsTable.innerHTML = '<tr><th>ID</th><th>Bin ID</th><th>Issue</th><th>Status</th><th>Created At</th><th>Action</th></tr>';
      complaints.forEach(row => {
        const tr = document.createElement('tr');
        const color = row.status === 'Resolved' ? 'green' : 'orange';
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${row.bin_id}</td>
          <td>${row.issue}</td>
          <td style="color:${color}; font-weight:bold;">${row.status}</td>
          <td>${row.created_at}</td>
          <td>${row.status !== 'Resolved' ? `<button onclick="resolveComplaint(${row.id})">Mark Resolved</button>` : ''}</td>
        `;
        complaintsTable.appendChild(tr);
      });

      // Render Chart AFTER logs are fetched
      renderChart(logs);
    }

    async function resolveComplaint(id) {
      const res = await fetch(`http://localhost:5000/api/complaints/${id}/resolve`, { method: 'PUT' });
      const data = await res.json();
      alert(data.message);
      fetchData();
    }

    function renderChart(logs) {
      const ctx = document.getElementById('binChart').getContext('2d');
      const labels = logs.map(row => row.bin_id);
      const data = logs.map(row => row.bin_level);

      if (binChart) binChart.destroy(); // clear old chart

      binChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Bin Fill Level (%)',
            data,
            backgroundColor: data.map(v => v > 80 ? 'rgba(231,76,60,0.8)' : 'rgba(46,204,113,0.8)')
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: { display: true, text: 'Fill Level (%)' }
            }
          }
        }
      });
    }

    // Initial load
    fetchData();
  </script>
</body>
</html>
